rules_version = '2';  
service cloud.firestore {  
  match /databases/{database}/documents {  
      
    // Función helper para verificar autenticación  
    function isAuthenticated() {  
      return request.auth != null;  
    }  
      
    // Función helper para verificar ownership  
    function isOwner(userId) {  
      return isAuthenticated() && request.auth.uid == userId;  
    }  
      
    // Colección de usuarios  
    match /users/{userId} {  
      // Solo el usuario puede leer/escribir su propio documento  
      allow read, write: if isOwner(userId);  
        
      // Subcolección de borradores (drafts)  
      match /drafts/{draftId} {  
        allow read, write: if isOwner(userId);  
      }  
        
      // Subcolección de inventario  
      match /inventory/{itemId} {  
        allow read, write: if isOwner(userId);  
          
        // Validar estructura de datos en escritura  
        allow create: if isOwner(userId)   
          && request.resource.data.keys().hasAll(['name', 'expiryDate', 'quantity'])  
          && request.resource.data.name is string  
          && request.resource.data.quantity is number  
          && request.resource.data.quantity > 0;  
          
        allow update: if isOwner(userId)  
          && request.resource.data.keys().hasAll(['name', 'expiryDate', 'quantity']);  
      }  
        
      // Subcolección de preferencias  
      match /preferences/{prefId} {  
        allow read, write: if isOwner(userId);  
      }  
        
      // Subcolección de uso mensual  
      match /usage/{document=**} {  
        allow read, write: if isOwner(userId);  
      }  
        
      // Subcolección de suscripción (solo lectura para cliente)  
      match /subscription/{document=**} {  
        allow read: if isOwner(userId);  
        allow write: if false; // Solo Cloud Functions pueden escribir  
      }  
        
      // Subcolección de caché de recetas  
      match /recipeCache/{document=**} {  
        allow read, write: if isOwner(userId);  
      }  
    }  
      
    // Denegar acceso a cualquier otra ruta  
    match /{document=**} {  
      allow read, write: if false;  
    }  
  }  
}